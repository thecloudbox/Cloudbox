# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # Base box
  config.vm.box = "ubuntu/jammy64"
  
  # CloudSentinel Master Node
  config.vm.define "cloudsentinel-master" do |master|
    master.vm.hostname = "cloudsentinel-master"
    master.vm.network "private_network", ip: "192.168.56.10"
    master.vm.network "forwarded_port", guest: 3000, host: 3000
    master.vm.network "forwarded_port", guest: 9090, host: 9090
    master.vm.network "forwarded_port", guest: 3001, host: 3001
    
    master.vm.provider "virtualbox" do |vb|
      vb.memory = "4096"
      vb.cpus = 2
      vb.name = "cloudsentinel-master"
    end
    
    master.vm.provision "shell", inline: <<-SHELL
      # Update system
      apt-get update
      apt-get upgrade -y
      
      # Install Docker
      curl -fsSL https://get.docker.com -o get-docker.sh
      sh get-docker.sh
      usermod -aG docker vagrant
      
      # Install Docker Compose
      curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
      chmod +x /usr/local/bin/docker-compose
      
      # Install Kubernetes tools
      curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list
      apt-get update
      apt-get install -y kubectl kubelet kubeadm
      
      # Install k3s (lightweight Kubernetes)
      curl -sfL https://get.k3s.io | sh -
      
      # Copy kubeconfig for vagrant user
      mkdir -p /home/vagrant/.kube
      cp /etc/rancher/k3s/k3s.yaml /home/vagrant/.kube/config
      chown -R vagrant:vagrant /home/vagrant/.kube
      
      # Install Helm
      curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      
      echo "CloudSentinel Master Node setup complete!"
      echo "Access CloudSentinel at: http://192.168.56.10:3000"
      echo "Access Prometheus at: http://192.168.56.10:9090"
      echo "Access Grafana at: http://192.168.56.10:3001"
    SHELL
  end
  
  # Worker Node 1
  config.vm.define "worker-1" do |worker|
    worker.vm.hostname = "cloudsentinel-worker-1"
    worker.vm.network "private_network", ip: "192.168.56.11"
    
    worker.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 1
      vb.name = "cloudsentinel-worker-1"
    end
    
    worker.vm.provision "shell", inline: <<-SHELL
      apt-get update
      curl -fsSL https://get.docker.com -o get-docker.sh
      sh get-docker.sh
      usermod -aG docker vagrant
      echo "Worker Node 1 setup complete!"
    SHELL
  end
  
  # Worker Node 2
  config.vm.define "worker-2" do |worker|
    worker.vm.hostname = "cloudsentinel-worker-2"
    worker.vm.network "private_network", ip: "192.168.56.12"
    
    worker.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 1
      vb.name = "cloudsentinel-worker-2"
    end
    
    worker.vm.provision "shell", inline: <<-SHELL
      apt-get update
      curl -fsSL https://get.docker.com -o get-docker.sh
      sh get-docker.sh
      usermod -aG docker vagrant
      echo "Worker Node 2 setup complete!"
    SHELL
  end
end
